services:
  # サービス名: Docker Compose内でこのコンテナを管理するための名前
  gpu-jupyter-service:

    # ---------------------------------------------------------
    # イメージのビルド設定 (docker build -t gpu-image .)
    # ---------------------------------------------------------
    build:
      context: .             # ビルドを行うディレクトリ (コマンドの '.' に相当)

    image: gpu-image         # ビルド完成後につけるイメージ名

    # ---------------------------------------------------------
    # コンテナの基本設定 (--name gpu-container)
    # ---------------------------------------------------------
    container_name: gpu-container

    # ---------------------------------------------------------
    # ポートとボリューム (-p 8888:8888, -v $(pwd):/workspace)
    # ---------------------------------------------------------
    ports:
      - "8888:8888"          # ホストのポート : コンテナのポート
    volumes:
      - .:/workspace         # Composeでは '.' が $(pwd) を意味します

    # ---------------------------------------------------------
    # 4. GPUの割り当て (--gpus all)
    # ---------------------------------------------------------
    # ComposeでGPUを使うための記述方法
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    # ---------------------------------------------------------
    # 5. 対話モードの維持 (-it)
    # ---------------------------------------------------------
    stdin_open: true         # -i (interactive) に相当。標準入力を開いたままにする。
    tty: true                # -t (tty) に相当。仮想ターミナルを割り当てる。

    # ---------------------------------------------------------
    # 6. コンテナの実行コマンド (Jupyter Labの起動)
    # ---------------------------------------------------------
    # Dockerfileのデフォルトコマンド (CMD ["/bin/bash"]) を上書き
    # コンテナのメインプロセス（PID 1）としてJupyter Labをフォアグラウンドで起動
    # コンテナ稼働中はJupyterサーバーが常に待機する状態にする
    command: jupyter-lab --ip 0.0.0.0 --allow-root --no-browser